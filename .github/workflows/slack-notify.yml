name: Slack Notify

on:
  workflow_call:
    inputs:
      template_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      project_name:
        required: true
        type: string
      deploy_target:
        required: false
        type: string
        default: ''
      cluster_name:
        required: false
        type: string
        default: ''
    secrets:
      slack_webhook_url:
        required: true

jobs:
  notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout shared templates
        uses: actions/checkout@v4
        with:
          repository: nwcommerce/.github
          ref: main
          sparse-checkout: slack-templates
          path: .shared

      - name: Render & send Slack payload
        shell: bash
        env:
          WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
          TEMPLATE_PATH: .shared/slack-templates/${{ inputs.template_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PROJECT_NAME: ${{ inputs.project_name }}
          DEPLOY_TARGET: ${{ inputs.deploy_target }}
          CLUSTER_NAME: ${{ inputs.cluster_name }}
          GH_SHA: ${{ github.sha }}
          GH_ACTOR: ${{ github.actor }}
          GH_REF_NAME: ${{ github.ref_name }}
          GH_SERVER_URL: ${{ github.server_url }}
          GH_REPOSITORY: ${{ github.repository }}
          GH_RUN_ID: ${{ github.run_id }}
        run: |
          python3 -c "
          import os, sys
          from pathlib import Path
          import urllib.request, urllib.error

          template_path = Path(os.environ['TEMPLATE_PATH'])
          if not template_path.exists():
              print('::error::Template not found: ' + str(template_path), flush=True)
              sys.exit(1)

          s = template_path.read_text(encoding='utf-8')

          sha = os.environ.get('GH_SHA', '')
          placeholders = {
              'ENVIRONMENT':       os.environ.get('ENVIRONMENT', ''),
              'PROJECT_NAME':      os.environ.get('PROJECT_NAME', ''),
              'DEPLOY_TARGET':     os.environ.get('DEPLOY_TARGET', ''),
              'CLUSTER_NAME':      os.environ.get('CLUSTER_NAME', ''),
              'GITHUB_SHA':        sha,
              'GITHUB_SHA_SHORT':  sha[:7],
              'GITHUB_ACTOR':      os.environ.get('GH_ACTOR', ''),
              'GITHUB_REF_NAME':   os.environ.get('GH_REF_NAME', ''),
              'GITHUB_SERVER_URL': os.environ.get('GH_SERVER_URL', ''),
              'GITHUB_REPOSITORY': os.environ.get('GH_REPOSITORY', ''),
              'GITHUB_RUN_ID':     os.environ.get('GH_RUN_ID', ''),
          }
          for key, val in placeholders.items():
              s = s.replace('{{' + key + '}}', val)

          payload = s.encode('utf-8')
          webhook_url = os.environ['WEBHOOK_URL']

          req = urllib.request.Request(
              webhook_url,
              data=payload,
              headers={'Content-Type': 'application/json'},
              method='POST',
          )
          try:
              with urllib.request.urlopen(req) as resp:
                  body = resp.read().decode()
                  print('Slack response: ' + str(resp.status) + ' ' + body, flush=True)
                  if body.strip() != 'ok':
                      print('::warning::Slack returned non-ok response: ' + body)
          except urllib.error.HTTPError as e:
              body = e.read().decode()
              print('::error::Slack webhook failed: ' + str(e.code) + ' ' + body, flush=True)
              sys.exit(1)
          "
